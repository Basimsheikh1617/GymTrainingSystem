@model MemeberFee;

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
@using GymTrainingSystem.Helper
@{
    var sessionUser = ApplicationHelper.GetUserSession(Context);

}
<div class="containers">
    <div class="row">
        <div class="col-lg-6">
            <h2>💪 @ViewBag.Name Fees Payment</h2>
            <p class="subtitle">Enter member payment details below</p>

            <!-- ✅ Clean form - removed data-ajax attributes -->
            <form asp-controller="Fees"
                  asp-action="FeesPaid"
                  method="post"
                  autocomplete="off"
                  id="paymentForm">
                <input asp-for="ClientId" name="ClientId" value="@ViewBag.ClientId" hidden readonly />

                <label>Member ID</label>
                <select asp-for="MemberId" class="form-control" required>
                    <option value="">Select</option>
                    @if (ViewBag.List != null)
                    {
                        foreach (var rec in ViewBag.List)
                        {
                            <option value="@rec.MemberId">@rec.Name</option>
                        }
                    }
                </select>

                <label>Payment Date</label>
                <input asp-for="Date" type="date" id="Date" required>

                <label>Status</label>
                <select asp-for="Status" id="Status" required>
                    <option value="">Select Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                    <option value="Overdue">Overdue</option>
                </select>

                <label>Fees (Rs)</label>
                <input asp-for="Fees" type="number" id="Fees" placeholder="Enter Amount" step="0.01" required>

                <button class="btnns" type="submit">Submit Payment</button>
            </form>

            <div id="successMsg" class="success hidden">✅ Payment Recorded Successfully!</div>
        </div>

        <div class="col-lg-6">
            <!-- Professional Payslip -->
            <div id="payslip" class="payslip hidden">
                <div class="slipheader">
                    <div class="logo">🏋️‍♂️ @sessionUser?.ClientName</div>
                    <div class="invoice-info">
                        <h3>Payment Receipt</h3>
                        <p><strong>Receipt No:</strong> <span id="receiptId"></span></p>
                        <p><strong>Date:</strong> <span id="slipDate"></span></p>
                    </div>
                </div>
                <hr>

                <div class="details">
                    <p><strong>Gym:</strong> <span id="slipClient">@sessionUser?.ClientName</span></p>
                    <p><strong>Member:</strong> <span id="slipMember"></span></p>
                    <p><strong>Status:</strong> <span id="slipStatus"></span></p>
                </div>

                <div class="summary">
                    <table>
                        <tr>
                            <th>Description</th>
                            <th>Amount (Rs)</th>
                        </tr>
                        <tr>
                            <td>Monthly Gym Fees</td>
                            <td id="slipFees"></td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total Paid</strong></td>
                            <td><strong id="slipTotal"></strong></td>
                        </tr>
                    </table>
                </div>

                <div class="footers">
                    <p>Thank you for staying fit with <strong>@ViewBag.Name</strong> 🏋️‍♀️</p>
                    <button id="printSlipBtn" class="printBtn">🖨️ Print Receipt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:9999; text-align:center;">
        <div style="position: relative; top: 40%;">
            <i class="fas fa-spinner fa-spin fa-3x text-success"></i>
            <p>Saving member...</p>
        </div>
    </div>
</div>

<style>
    .containers {
        border-radius: 15px;
        padding: 30px 40px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        transition: 0.3s;
        background: #8080803b;
    }

    h2 {
        text-align: center;
    }

    label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
    }

    input, select {
        width: 100%;
        padding: 10px;
        margin-bottom: 18px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    .btnns {
        width: 100%;
        background: #283e51;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
    }

    .success {
        text-align: center;
        color: #2ecc71;
        font-weight: bold;
        margin-top: 15px;
        opacity: 0;
        transform: scale(0.9);
        transition: all 0.5s ease;
    }

    .hidden {
        display: none;
    }

    .payslip {
        margin-top: 25px;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 20px;
    }

    .summary th, .summary td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
    }

    .printBtn {
        margin-top: 10px;
        background: #2ecc71;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .summary {
        display: grid;
    }
    @@media print {
        body *

    {
        visibility: hidden;
    }

    #payslip, #payslip * {
        visibility: visible;
    }

    #payslip {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
    }

    }

    @@media print {

    /* صرف payslip ہی پرنٹ ہو */
    body * {
        visibility: hidden !important;
    }

    #payslip, #payslip * {
        visibility: visible !important;
    }

    #payslip {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        margin: 0;
        padding: 0;
    }

    /* پرنٹ بٹن چھپا دیں */
    #printSlipBtn {
        display: none !important;
    }

  
}

</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const printBtn = document.getElementById("printSlipBtn");

    $("#paymentForm").on("submit", function (e) {
        e.preventDefault();

        const client = $("#ClientId").val();
        const memberName = $("#MemberId option:selected").text();;
        const date = $("#Date").val();
        const status = $("#Status").val();
        const fees = parseFloat($("#Fees").val()).toFixed(2);
        const receiptId = "R-" + Math.floor(Math.random() * 100000);

        $.ajax({
            url: '/Fees/FeesPaid',
            type: 'POST',
            data: $(this).serialize(),
            beforeSend: function () {
                $("#loader").show();
            },
            complete: function () {
                $("#loader").hide();
            },
            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Payment recorded successfully.',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                     
                        $("#slipMember").text(memberName);
                        $("#slipDate").text(date);
                        $("#slipStatus").text(status);
                        $("#slipFees").text(fees);
                        $("#slipTotal").text(fees);
                        $("#receiptId").text(receiptId);
                        $("#payslip").removeClass("hidden");
                        
                    });
                    // $("#paymentForm")[0].reset();
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Already Paid!',
                        text: 'This member has already paid for this date.',
                        confirmButtonColor: '#ffc107'
                    });
                }
            },
            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong! Please try again.'
                });
            }
        });
    });

    // Manual print button
    printBtn.addEventListener("click", () => {
        window.print();
    });
</script>
